"use strict";(self.webpackChunkhydra_head_protocol_docs=self.webpackChunkhydra_head_protocol_docs||[]).push([[8110],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},h="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),h=c(n),m=o,u=h["".concat(s,".").concat(m)]||h[m]||p[m]||r;return n?a.createElement(u,i(i({ref:t},d),{},{components:n})):a.createElement(u,i({ref:t},d))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[h]="string"==typeof e?e:o,i[1]=l;for(var c=2;c<r;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},13522:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var a=n(87462),o=(n(67294),n(3905));const r={},i="Handling rollbacks",l={unversionedId:"dev/rollbacks/index",id:"dev/rollbacks/index",title:"Handling rollbacks",description:"Rollbacks are fundamental to the operation of the Cardano chain. Any application built on Cardano, including Hydra, must anticipate occasional rollbacks, which are reversals of confirmed transactions due to chain reorganization or other consensus adjustments.",source:"@site/docs/dev/rollbacks/index.md",sourceDirName:"dev/rollbacks",slug:"/dev/rollbacks/",permalink:"/head-protocol/docs/dev/rollbacks/",draft:!1,editUrl:"https://github.com/cardano-scaling/hydra/tree/master/docs/docs/dev/rollbacks/index.md",tags:[],version:"current",frontMatter:{},sidebar:"developerDocumentation",previous:{title:"Networking",permalink:"/head-protocol/docs/dev/architecture/networking"},next:{title:"Scalability",permalink:"/head-protocol/docs/dev/scalability"}},s={},c=[{value:"Understanding rollbacks",id:"understanding-rollbacks",level:2},{value:"How do rollbacks impact the Hydra node?",id:"how-do-rollbacks-impact-the-hydra-node",level:2},{value:"How do we handle them?",id:"how-do-we-handle-them",level:2}],d={toc:c},h="wrapper";function p(e){let{components:t,...r}=e;return(0,o.kt)(h,(0,a.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"handling-rollbacks"},"Handling rollbacks"),(0,o.kt)("p",null,"Rollbacks are fundamental to the operation of the Cardano chain. Any application built on Cardano, including Hydra, must anticipate occasional rollbacks, which are reversals of confirmed transactions due to chain reorganization or other consensus adjustments."),(0,o.kt)("p",null,"This document provides an overview of rollbacks, their origins, and details how Hydra heads manage them."),(0,o.kt)("h2",{id:"understanding-rollbacks"},"Understanding rollbacks"),(0,o.kt)("p",null,"Rollbacks occur on the Cardano chain, and other decentralized blockchains, due to its ",(0,o.kt)("em",{parentName:"p"},"asynchronous")," nature. Each node maintains its own view of the chain's state, updating it through communication with other nodes. This process involves exchanging messages about known blocks, which can lead to new blocks being produced that may be valid or invalid. As a result, the chain's state is ",(0,o.kt)("em",{parentName:"p"},"eventually consistent"),", with all nodes agreeing on its state after processing a certain number of blocks."),(0,o.kt)("p",null,"In reality, 'rollbacks' are a misnomer; it's more accurate to refer to these events as 'forks'. Let's delve into what this means from the perspective of three nodes running a Hydra head. The following diagram illustrates each node's view of the layer 1 chain."),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(86743).Z,width:"4939",height:"3239"})),(0,o.kt)("p",null,"The ",(0,o.kt)("em",{parentName:"p"},"immutable part")," is guaranteed to be identical on all nodes, extending ",(0,o.kt)("inlineCode",{parentName:"p"},"k")," blocks in the past from the current ",(0,o.kt)("em",{parentName:"p"},"tip")," (on the mainnet, ",(0,o.kt)("inlineCode",{parentName:"p"},"k")," is 2160). Here's an example scenario: node 2 receives a new block identical to node 1's view, but node 3 receives a different one. Eventually, because node 3's chain is shorter than the others, it will be superseded by a longer chain, resulting in a rollback."),(0,o.kt)("p",null,"The impact on the node's ",(0,o.kt)("em",{parentName:"p"},"direct chain")," observer is detailed in the following diagram:"),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(10111).Z,width:"4939",height:"3239"})),(0,o.kt)("p",null,"When new blocks become available, the ",(0,o.kt)("inlineCode",{parentName:"p"},"ChainSync")," client receives a ",(0,o.kt)("inlineCode",{parentName:"p"},"RollForward")," message for each new block. In the event of a fork, it first receives a ",(0,o.kt)("inlineCode",{parentName:"p"},"RollBackward")," message indicating a ",(0,o.kt)("em",{parentName:"p"},"point")," that identifies the slot and block hash where the rollback occurred (represented as a single number in the figure). After this rollback point, the client resumes receiving new blocks through ",(0,o.kt)("inlineCode",{parentName:"p"},"RollForward")," messages."),(0,o.kt)("h2",{id:"how-do-rollbacks-impact-the-hydra-node"},"How do rollbacks impact the Hydra node?"),(0,o.kt)("p",null,"Rollbacks pose challenges because when a transaction is observed on-chain, it can alter the state of the head in several stages: ",(0,o.kt)("em",{parentName:"p"},"initializing")," it, collecting ",(0,o.kt)("em",{parentName:"p"},"commits"),", opening the head via the ",(0,o.kt)("inlineCode",{parentName:"p"},"CollectCom")," transaction, and ultimately ",(0,o.kt)("em",{parentName:"p"},"closing")," it and ",(0,o.kt)("em",{parentName:"p"},"fanning out")," the head's final UTXO."),(0,o.kt)("p",null,"The following diagram illustrates the issue where a rollback can lead to potentially conflicting ",(0,o.kt)("inlineCode",{parentName:"p"},"Commit")," transactions:"),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(70353).Z,width:"4939",height:"3239"})),(0,o.kt)("p",null,"If the head does not properly handle the rollback, it risks becoming inconsistent with other nodes participating in the head. Therefore, any rollback observed at the ",(0,o.kt)("inlineCode",{parentName:"p"},"Direct")," chain component level must be promptly communicated to the ",(0,o.kt)("inlineCode",{parentName:"p"},"HeadLogic"),". This ensures that the ",(0,o.kt)("inlineCode",{parentName:"p"},"HeadLogic")," can reset its state to maintain consistency with the changes on layer 1."),(0,o.kt)("p",null,"The consequences of a rollback on the head's state vary depending on when the rollback occurs:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"If the rollback occurs before or after the head is opened \u2013 for example, before the ",(0,o.kt)("inlineCode",{parentName:"p"},"CollectCom")," transaction or after the ",(0,o.kt)("inlineCode",{parentName:"p"},"Close")," \u2013 the resolution is relatively straightforward: the head's state can be reset to the point it was at before the rolled-back transaction was observed.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"If the rollback occurs while the head is open \u2013 for instance, if the ",(0,o.kt)("inlineCode",{parentName:"p"},"CollectCom")," transaction is rolled back \u2013 it poses greater challenges. At this point, the node has already begun exchanging messages with its peers, and its state no longer depends solely on the blockchain."))),(0,o.kt)("h2",{id:"how-do-we-handle-them"},"How do we handle them?"),(0,o.kt)("admonition",{type:"warning"},(0,o.kt)("p",{parentName:"admonition"},"\ud83d\udee0 Hydra currently handles rollbacks gracefully in simpler cases, such as scenario 1 above. However, in cases where a ",(0,o.kt)("inlineCode",{parentName:"p"},"CollectCom")," transaction rollback occurs, which can easily lead to a head becoming stale due to desynchronization among nodes (where one node resets its state before the rollback and loses track of subsequent events during the head's open phase), the head will need to be closed.")),(0,o.kt)("p",null,"Rollback handling has been partially deactivated in Hydra per ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/input-output-hk/hydra/blob/master/docs/adr/2023-04-26_023-single-state.md"},"ADR-23"),". This section will be updated with a more comprehensive and refined rollback handling approach with issue ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/input-output-hk/hydra/issues/185"},"#185"),"."))}p.isMDXComponent=!0},86743:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rollbacks-1-6f82628f5596e94e392e900079056ec0.jpg"},10111:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rollbacks-2-7ecc9b20cb887261db87180040fe79ba.jpg"},70353:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/rollbacks-3-9b053577585720457d34d61f6243a5fe.jpg"}}]);